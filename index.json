[{"content":" 2023.10.23-2023.10.30 富山大学・持続可能社会創成学環 (with Prof. Jun Ma) # ","date":"23 October 2023","permalink":"/posts/2023-4/","section":"Posts","summary":" 2023.10.23-2023.10.30 富山大学・持続可能社会創成学環 (with Prof. Jun Ma) # ","title":"Data Analysis for Sustainability Science using R"},{"content":"","date":"23 October 2023","permalink":"/","section":"Jie Yang","summary":"","title":"Jie Yang"},{"content":"","date":"23 October 2023","permalink":"/posts/","section":"Posts","summary":"","title":"Posts"},{"content":"","date":"23 October 2023","permalink":"/tags/r/","section":"Tags","summary":"","title":"R"},{"content":" ","date":"23 October 2023","permalink":"/tags/","section":"Tags","summary":" ","title":"Tags"},{"content":" ","date":"17 July 2023","permalink":"/notes/","section":"Notes","summary":" ","title":"Notes"},{"content":" Moran\u0026rsquo;s test for spatial autocorrelation\nStata command: estat moran Testing for global spatial autocorrelation in Stata ","date":"17 July 2023","permalink":"/notes/spatial/","section":"Notes","summary":" Moran\u0026rsquo;s test for spatial autocorrelation\nStata command: estat moran Testing for global spatial autocorrelation in Stata ","title":"Spatial Econometrics"},{"content":"","date":"17 July 2023","permalink":"/tags/stata/","section":"Tags","summary":"","title":"Stata"},{"content":"","date":"16 July 2023","permalink":"/tags/causal-forest/","section":"Tags","summary":"","title":"Causal Forest"},{"content":" Generalized random forests\nPackage grf in R ","date":"16 July 2023","permalink":"/notes/causal-forest/","section":"Notes","summary":" Generalized random forests\nPackage grf in R ","title":"Causal Forest"},{"content":"","date":"16 July 2023","permalink":"/tags/environmental-economics/","section":"Tags","summary":"","title":"Environmental Economics"},{"content":"","date":"16 July 2023","permalink":"/tags/github/","section":"Tags","summary":"","title":"Github"},{"content":" Github page\nTheme Hugo \u0026amp; Blowfish ","date":"16 July 2023","permalink":"/notes/github-page/","section":"Notes","summary":" Github page\nTheme Hugo \u0026amp; Blowfish ","title":"Github Page"},{"content":" Related R packages # library(terra) # spatial data analysis package library(tidyverse) # data processing package library(sf) # geodata encoding package library(fs) # file system operation package To begin with # We need the following files for the data processing.\nTIF data of nightlight Shp files are needed to identify the study area Data description 4.1 shp files of administrative division in Japan, suppose the file name is jpn_adm 4.2 shp files link: https://data.humdata.org/dataset/cod-ab-jpn 4.3 nightlight tif data in Japan during 2018/09/05\u0026ndash;2018/09/07, suppose the file name is traildata_japan 4.4 data link: https://eogdata.mines.edu/nighttime_light/nightly/rade9d/ Example using trail data # Setting and checking # Daily nightlight tif files during 2018/09/05\u0026ndash;2018/09/07 in will be used to show how to create prefecture-level panel data using R. Before that, check the nightlight data and geo data at first\n# load tif file using \u0026#39;rast\u0026#39; code in package \u0026#39;terra\u0026#39; rast(\u0026#34;trialdata_japan/SVDNB_npp_d20180905.rade9d.tif\u0026#34;) -\u0026gt; nightlight nightlight # this is global data # load shp file read_sf(\u0026#34;jpn_adm/jpn_admbnda_adm1_2019.shp\u0026#34;) -\u0026gt; pref pref vect(pref) -\u0026gt; pref pref # check files in folder \u0026#39;trialdata_japan\u0026#39;, save the folder as \u0026#39;datafile\u0026#39; dir_ls(\u0026#34;trialdata_japan\u0026#34;) %\u0026gt;% as.character() %\u0026gt;% as_tibble() %\u0026gt;% mutate(date = lubridate::ymd(str_match(basename(value), \u0026#34;\\\\d{8}\u0026#34;)[,1])) %\u0026gt;% arrange(date) -\u0026gt; datafile File trialdata_japan/SVDNB_npp_d20180905.rade9d.tif, which is saved as df1, will be used an example to show the detailed steps to process nightlight tif data, while later loop will be used to operate all the nightlight files. The following R codes will also show how to use loop to deal with all the files at once on both prefecture and municipality levels\n# check the name of the first file and save it as df1 datafile$value[1] rast(datafile$value[1] ) -\u0026gt; df1 Create a panel data # Step 1: Load country, prefecture, municipality shp files\nread_sf(\u0026#34;jpn_adm/jpn_admbnda_adm0_2019.shp\u0026#34;) %\u0026gt;% st_transform(4326) -\u0026gt; jp jp read_sf(\u0026#34;jpn_adm/jpn_admbnda_adm1_2019.shp\u0026#34;) %\u0026gt;% st_transform(4326) -\u0026gt; pref pref read_sf(\u0026#34;jpn_adm/jpn_admbnda_adm2_2019.shp\u0026#34;) %\u0026gt;% st_transform(4326) -\u0026gt; municipal municipal Step 2: Use a function to calculate the statistics of the nightlight data\nThis is an example using one data file # write shp data to rds data for later use jp %\u0026gt;% write_rds(\u0026#34;jp.rds\u0026#34;) # change the data to spatial vectors vect(jp) -\u0026gt; jp # cut out the data of japan, note that this step will take time df1 %\u0026gt;% terra::mask(jp) %\u0026gt;% terra::crop(jp) -\u0026gt; jpdf1 # check if there are extreme values using summary, such as value \u0026lt; 0 summary(jpdf1) # plot the data of japan roughly raster::plot(jpdf1) # calculate the mean value of nightlight by province vect(pref) -\u0026gt; pref terra::extract(jpdf1, pref, fun = \u0026#34;mean\u0026#34;, na.rm = T) -\u0026gt; pref_mean # load the pref data again because spatial vectors cannot be used for merge read_sf(\u0026#34;jpn_adm/jpn_admbnda_adm1_2019.shp\u0026#34;) %\u0026gt;% st_transform(4326) -\u0026gt; pref pref %\u0026gt;% bind_cols(pref_mean) -\u0026gt; pref_mean # check data (variables and data type) pref_mean # mean value of nightlight data by prefecture in 2018/09/05 Step 3: Use loop to process all the files in folder `trialdata_japan'\nIn this step, package parallel is used to operate the codes by multiple lines. This loop will calculate the mean value of nightlight data on the prefecture level and municipality level\n# create new folders to save data dir.create(\u0026#34;pref\u0026#34;) # create a new file named \u0026#39;pref\u0026#39; dir.create(\u0026#34;municipal\u0026#34;) # create a new file named \u0026#39;municipal\u0026#39; # loop to create prefecture and municipality level data # multiple operation when data amount is large library(parallel) makeCluster(3) -\u0026gt; cl # employ 3 operations at the same time clusterExport(cl, \u0026#34;pref\u0026#34;) clusterExport(cl, \u0026#34;municipal\u0026#34;) clusterExport(cl, \u0026#34;jp\u0026#34;) clusterExport(cl, \u0026#34;%\u0026gt;%\u0026#34;) clusterExport(cl, \u0026#34;datafile\u0026#34;) parLapply(cl, 1:nrow(datafile), function(x){ if(!file.exists(paste0(\u0026#34;pref/\u0026#34;, datafile$date[x], \u0026#34;.rds\u0026#34;))) { library(terra) # change jp data to spatial vectors jp \u0026lt;- terra::vect(sf::st_sf(jp)) terra::rast(datafile$value[x]) -\u0026gt; nightlight # cut out japan for each tif file nightlight %\u0026gt;% terra::crop(jp) %\u0026gt;% terra::mask(jp) -\u0026gt; nightlight # rule out unreasonable or extreme values nightlight[nightlight \u0026lt; 0] \u0026lt;- NA nightlight[nightlight \u0026gt; 1000] \u0026lt;- NA nightlight %\u0026gt;% # calculate mean values on the prefecture level terra::extract(terra::vect(pref), fun = mean, na.rm = T) %\u0026gt;% tidyr::as_tibble() %\u0026gt;% dplyr::mutate(year = x) %\u0026gt;% # save rds file by date readr::write_rds(paste0(\u0026#34;pref/\u0026#34;, datafile$date[x], \u0026#34;.rds\u0026#34;)) nightlight %\u0026gt;% # calculate mean values on the municipality level terra::extract(terra::vect(municipal), fun = mean, na.rm = T) %\u0026gt;% tidyr::as_tibble() %\u0026gt;% dplyr::mutate(year = x) %\u0026gt;% readr::write_rds(paste0(\u0026#34;municipal/\u0026#34;, datafile$date[x], \u0026#34;.rds\u0026#34;)) } }) -\u0026gt; nightlight_1 Step 4: Data combination after loop\n# load shp files again library(sf) read_sf(\u0026#34;jpn_adm/jpn_admbnda_adm0_2019.shp\u0026#34;) %\u0026gt;% st_transform(4326) -\u0026gt; jp read_sf(\u0026#34;jpn_adm/jpn_admbnda_adm1_2019.shp\u0026#34;) %\u0026gt;% st_transform(4326) -\u0026gt; pref read_sf(\u0026#34;jpn_adm/jpn_admbnda_adm2_2019.shp\u0026#34;) %\u0026gt;% st_transform(4326) -\u0026gt; municipal # combine nightlight data by date library(tidyverse) lapply(fs::dir_ls(\u0026#34;pref\u0026#34;), FUN = function(x){ readr::read_rds(x) %\u0026gt;% # delete variable \u0026#39;year\u0026#39; dplyr::select(-year) }) %\u0026gt;% bind_cols() %\u0026gt;% # combine by column # delete variables contain \u0026#39;ID\u0026#39; dplyr::select(-contains(\u0026#34;ID\u0026#34;)) %\u0026gt;% # add new numeric variable \u0026#39;ID\u0026#39; mutate(ID = as.numeric(row.names(.))) %\u0026gt;% dplyr::select(ID, everything()) %\u0026gt;% # reshape data frame gather(-ID, key = \u0026#34;key\u0026#34;, value = \u0026#34;value\u0026#34;) %\u0026gt;% # add \u0026#39;date\u0026#39; mutate(date = lubridate::ymd(str_match(basename(key), \u0026#34;\\\\d{8}\u0026#34;)[,1])) %\u0026gt;% dplyr::select(-key) -\u0026gt; prefdf # save data as \u0026#39;prefdf\u0026#39; # check the data prefdf Step 5: Write dataset to xlsx/dta file\n# merge nightlight data with pref data and write to excel data # merge pref data to the left side of prefdf data using \u0026#39;left_join\u0026#39; prefdf %\u0026gt;% left_join( pref %\u0026gt;% st_drop_geometry() %\u0026gt;% mutate(ID = as.numeric(row.names(.))) ) %\u0026gt;% dplyr::select(-ID) %\u0026gt;% # select variables to keep and reorder dplyr::select(date, ADM1_EN, ADM1_JA, ADM1_PCODE, nightlight_mean = value) %\u0026gt;% # write to excel file writexl::write_xlsx(\u0026#34;nightlight_pref.xlsx\u0026#34;) prefdf %\u0026gt;% left_join( pref %\u0026gt;% st_drop_geometry() %\u0026gt;% mutate(ID = as.numeric(row.names(.))) ) %\u0026gt;% dplyr::select(-ID) %\u0026gt;% dplyr::select(date, ADM1_EN, ADM1_JA, ADM1_PCODE, nightlight_mean = value) %\u0026gt;% # write to dta file haven::write_dta(\u0026#34;nightlight_pref.dta\u0026#34;) Step 6: Repeat steps 4 and 5 to output municipality level data\nlapply(fs::dir_ls(\u0026#34;municipal\u0026#34;), FUN = function(x){ readr::read_rds(x) %\u0026gt;% dplyr::select(-year) }) %\u0026gt;% bind_cols() %\u0026gt;% dplyr::select(-contains(\u0026#34;ID\u0026#34;)) %\u0026gt;% mutate(ID = as.numeric(row.names(.))) %\u0026gt;% dplyr::select(ID, everything()) %\u0026gt;% gather(-ID, key = \u0026#34;key\u0026#34;, value = \u0026#34;value\u0026#34;) %\u0026gt;% mutate(date = lubridate::ymd(str_match(basename(key), \u0026#34;\\\\d{8}\u0026#34;)[,1])) %\u0026gt;% dplyr::select(-key) -\u0026gt; municipaldf municipaldf municipaldf %\u0026gt;% left_join( municipal %\u0026gt;% st_drop_geometry() %\u0026gt;% mutate(ID = as.numeric(row.names(.))) ) %\u0026gt;% dplyr::select(-ID) %\u0026gt;% dplyr::select(date, ADM1_EN, ADM1_JA, ADM1_PCODE, ADM2_EN, ADM2_JA, ADM2_PCODE, nightlight_mean = value) %\u0026gt;% writexl::write_xlsx(\u0026#34;nightlight_municipal.xlsx\u0026#34;) municipaldf %\u0026gt;% left_join( municipal %\u0026gt;% st_drop_geometry() %\u0026gt;% mutate(ID = as.numeric(row.names(.))) ) %\u0026gt;% dplyr::select(-ID) %\u0026gt;% dplyr::select(date, ADM1_EN, ADM1_JA, ADM1_PCODE, ADM2_EN, ADM2_JA, ADM2_PCODE, nightlight_mean = value) %\u0026gt;% haven::write_dta(\u0026#34;nightlight_municipal.dta\u0026#34;) Plot to check # nightlight distributed by municipality\nlibrary(ggplot2) library(ggspatial) read_sf(\u0026#34;jpn_adm/jpn_admbnda_adm2_2019.shp\u0026#34;) %\u0026gt;% st_transform(4326) -\u0026gt; municipal readxl::read_xlsx(\u0026#34;nightlight_municipal.xlsx\u0026#34;) %\u0026gt;% mutate(date = lubridate::ymd(date)) -\u0026gt; mydf1 municipal %\u0026gt;% left_join(mydf1) %\u0026gt;% ggplot() + geom_sf(aes(fill = nightlight_mean), size = 0.001, linewidth = 0.001, color = \u0026#34;white\u0026#34;) + facet_wrap(~ date, nrow = 1) + scico::scale_fill_scico( palette = \u0026#34;lajolla\u0026#34;, trans = \u0026#34;log10\u0026#34;, name=\u0026#34;nightlight\u0026#34;) + scale_x_continuous(expand = c(0.001, 0.001)) + scale_y_continuous(expand = c(0.001, 0.001)) + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), strip.text = element_text(colour = \u0026#34;gray30\u0026#34;, hjust = 0.5), legend.position = \u0026#34;bottom\u0026#34;, plot.margin = unit(rep(0.5, 4), \u0026#34;cm\u0026#34;), panel.grid.major = element_blank()) + guides(fill = guide_legend(nrow = 1, title.position = \u0026#34;top\u0026#34;, title.hjust = 0.5, label.position = \u0026#34;top\u0026#34;)) # \u0026gt; save as g_municipal and output jpg # ggsave(\u0026#34;municipalmap.jpg\u0026#34;, g_municipal) Nightlight intensity by municipality nightlight distributed by prefecture\nlibrary(ggspatial) read_sf(\u0026#34;jpn_adm/jpn_admbnda_adm1_2019.shp\u0026#34;) %\u0026gt;% st_transform(4326) -\u0026gt; pref readxl::read_xlsx(\u0026#34;nightlight_pref.xlsx\u0026#34;) %\u0026gt;% mutate(date = lubridate::ymd(date)) -\u0026gt; mydfpref1 pref %\u0026gt;% left_join(mydfpref1 ) %\u0026gt;% ggplot() + geom_sf(aes(fill = nightlight_mean), size = 0.001, linewidth = 0.001, color = \u0026#34;white\u0026#34;) + facet_wrap(~ date, nrow = 1) + scico::scale_fill_scico( palette = \u0026#34;lajolla\u0026#34;, trans = \u0026#34;log10\u0026#34;, name=\u0026#34;nightlight\u0026#34;) + scale_x_continuous(expand = c(0.001, 0.001)) + scale_y_continuous(expand = c(0.001, 0.001)) + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), strip.text = element_text(colour = \u0026#34;gray30\u0026#34;, hjust = 0.5), legend.position = \u0026#34;bottom\u0026#34;, plot.margin = unit(rep(0.5, 4), \u0026#34;cm\u0026#34;), panel.grid.major = element_blank()) + guides(fill = guide_legend(nrow = 1, title.position = \u0026#34;top\u0026#34;, title.hjust = 0.5, label.position = \u0026#34;top\u0026#34;)) # \u0026gt; save as g_pref and output jpg # ggsave(\u0026#34;prefmap.jpg\u0026#34;, g_pref) Nightlight intensity by prefecture ","date":"16 July 2023","permalink":"/posts/data1/","section":"Posts","summary":"Related R packages # library(terra) # spatial data analysis package library(tidyverse) # data processing package library(sf) # geodata encoding package library(fs) # file system operation package To begin with # We need the following files for the data processing.","title":"Nightlight Data"},{"content":" 2023.09.06-2023.09.13 甲南大学・経済学部 (集中講義) # Two roads diverged in a wood, which one do you choose? ","date":"16 July 2023","permalink":"/posts/2023-3/","section":"Posts","summary":" 2023.09.06-2023.09.13 甲南大学・経済学部 (集中講義) # Two roads diverged in a wood, which one do you choose? ","title":"環境経済学II"},{"content":" 2023.09.02-2023.09.03 広島大学・総合科学系 (集中講義) # ","date":"15 July 2023","permalink":"/posts/2023-2/","section":"Posts","summary":" 2023.09.02-2023.09.03 広島大学・総合科学系 (集中講義) # ","title":"Environmental Economics and Policy II"},{"content":" 2023.06.17-2023.06.18 広島大学・総合科学系 (集中講義) # ","date":"17 June 2023","permalink":"/posts/2023-1/","section":"Posts","summary":" 2023.06.17-2023.06.18 広島大学・総合科学系 (集中講義) # ","title":"Environmental Economics and Policy I"},{"content":"","date":"1 July 2022","permalink":"/tags/econometrics/","section":"Tags","summary":"","title":"Econometrics"},{"content":" 2022.07-2022.10 富山大学・持続可能社会創成学環 (with Prof. Jun Ma) # ","date":"1 July 2022","permalink":"/posts/2022-1/","section":"Posts","summary":" 2022.07-2022.10 富山大学・持続可能社会創成学環 (with Prof. Jun Ma) # ","title":"Environmental Economics; Data Analysis \u0026 GIS for Sustainability Science"},{"content":" 2021.10-2022.01 富山大学・経済学部 (with Prof. Jun Ma) # ","date":"1 October 2021","permalink":"/posts/2021-1/","section":"Posts","summary":" 2021.10-2022.01 富山大学・経済学部 (with Prof. Jun Ma) # ","title":"持続可能な経済成長に関するデータ分析"},{"content":" 2020.10-2021.01 富山大学・経済学部 (with Prof. Jun Ma and Prof. Masashi Yamamoto) # ","date":"2 October 2020","permalink":"/posts/2020-2/","section":"Posts","summary":" 2020.10-2021.01 富山大学・経済学部 (with Prof. Jun Ma and Prof. Masashi Yamamoto) # ","title":"データによる経済・経営分析"},{"content":" 2020.10-2021.01 大阪府立大学・人間社会システム科学研究科 # ","date":"1 October 2020","permalink":"/posts/2020-1/","section":"Posts","summary":" 2020.10-2021.01 大阪府立大学・人間社会システム科学研究科 # ","title":"環境経済学"},{"content":" Basic Info # Education: Graduate School of Economics, Kobe University (Ph.D in Economics) Current position: Researcher, Global Research Center for Advanced Sustainability Science (GRASS), University of Toyama Research Interests # Public service, pollution \u0026amp; health; Impacts of climate change and natural disasters; Water-energy nexus\nCV # Here is my CV.\n","date":"1 January 0001","permalink":"/about/","section":"About Me","summary":"Basic Info # Education: Graduate School of Economics, Kobe University (Ph.D in Economics) Current position: Researcher, Global Research Center for Advanced Sustainability Science (GRASS), University of Toyama Research Interests # Public service, pollution \u0026amp; health; Impacts of climate change and natural disasters; Water-energy nexus","title":"About Me"},{"content":"This is the advanced tag. Just like other listing pages in Blowfish, you can add custom content to individual taxonomy terms and it will be displayed at the top of the term listing. 🚀\nYou can also use these content pages to define Hugo metadata like titles and descriptions that will be used for SEO and other purposes.\n","date":"1 January 0001","permalink":"/tags/advanced/","section":"Tags","summary":"This is the advanced tag. Just like other listing pages in Blowfish, you can add custom content to individual taxonomy terms and it will be displayed at the top of the term listing.","title":"Advanced"},{"content":"","date":"1 January 0001","permalink":"/categories/","section":"Categories","summary":"","title":"Categories"},{"content":" DATABASE # Nightlight Data STATA # R # LATEX # ","date":"1 January 0001","permalink":"/data/","section":"Data","summary":" DATABASE # Nightlight Data STATA # R # LATEX # ","title":"Data"},{"content":"Dummy Second Author\u0026rsquo;s awesome dummy bio.\n","date":"1 January 0001","permalink":"/authors/secondauthor/","section":"Teaching","summary":"Dummy Second Author\u0026rsquo;s awesome dummy bio.","title":"Dummy Second Author"},{"content":"","date":"1 January 0001","permalink":"/tags/latex/","section":"Tags","summary":"","title":"Latex"},{"content":"Nuno\u0026rsquo;s awesome dummy bio.\n","date":"1 January 0001","permalink":"/authors/nunocoracao/","section":"Teaching","summary":"Nuno\u0026rsquo;s awesome dummy bio.","title":"Nuno Coração"},{"content":" PAPERS # 2023 # Storm and inequality # The Dark Side of Storm: Nightlight Data Analysis of the Relationship between Climate Disaster and Inequality (with Tembata Kaori and Kenji Takeuchi) (working on)\nClimate and energy # Impacts of Climate Change on Clean Energy Choices (working on)\n2022 # Energy and carbon # Renewable Energy or Thermal Efficiency Improvement: Assessing the Carbon Mitigation Effects of Energy Choices in China (with Yimeng Du and Teng Ma)\nAir pollution and health # The Final 28 Days: Prenatal Exposure to Air Pollution and Child Anthropometric Outcomes (with Xintong Chen and Yuki Yamamoto)\n2021 # Water and energy # Does Drought Increase Carbon Emissions? Evidence from Southwestern China (with Yijing Huang and Kenji Takeuchi)\n2020 # Water and health # Impacts of Water Provision on Child Health: Evidence from Rural China (with Kenji Takeuchi)\n2019 # Water and migration # Impacts of Water Scarcity on Migration in China (with Kenji Takeuchi)\n","date":"1 January 0001","permalink":"/research/","section":"Research","summary":"PAPERS # 2023 # Storm and inequality # The Dark Side of Storm: Nightlight Data Analysis of the Relationship between Climate Disaster and Inequality (with Tembata Kaori and Kenji Takeuchi) (working on)","title":"Research"},{"content":"","date":"1 January 0001","permalink":"/series/","section":"Series","summary":"","title":"Series"},{"content":"A quick example of how to start using author taxonomies in your articles.\n","date":"1 January 0001","permalink":"/authors/","section":"Teaching","summary":"A quick example of how to start using author taxonomies in your articles.","title":"Teaching"},{"content":" LECTURES # 2023 # University of Toyama: Statistics and R Konan University: Environmental Economics Hiroshima University: Environmental Economics II Hiroshima University: Environmental Economics I Hiroshima University 2022 # University of Toyama 2021 # University of Toyama: Statistics and Stata 2020 # University of Toyama: Statistics and R Osaka Metropolitan University: Environmental Economics Toyama ","date":"1 January 0001","permalink":"/teaching/","section":"Teaching","summary":" LECTURES # 2023 # University of Toyama: Statistics and R Konan University: Environmental Economics Hiroshima University: Environmental Economics II Hiroshima University: Environmental Economics I Hiroshima University 2022 # University of Toyama 2021 # University of Toyama: Statistics and Stata 2020 # University of Toyama: Statistics and R Osaka Metropolitan University: Environmental Economics Toyama ","title":"Teaching"}]